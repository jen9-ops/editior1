<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–û–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä v15.1</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#1a1b26">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/dracula.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/css/css.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/htmlmixed/htmlmixed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror-emmet/emmet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root {
      --bg-primary: #1a1b26; --bg-secondary: #24283b; --bg-tertiary: #16161e;
      --border-color: #414868; --text-primary: #c0caf5; --text-secondary: #a9b1d6;
      --accent-primary: #7aa2f7; --accent-green: #9ece6a; --accent-red: #f7768e;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.2);
    }
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; }
    #app-container { display: flex; flex-direction: column; height: 100vh; }
    .top-bar { padding: 6px 8px; flex-shrink: 0; display:flex; gap:6px; align-items:center; border-bottom: 1px solid var(--border-color); }
    .btn-icon { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; width: 34px; height: 34px; display:inline-flex; align-items:center; justify-content:center; transition: all 0.2s ease; box-shadow: var(--shadow-sm); }
    .btn-icon:hover { background-color: #3b4261; border-color: #565f89; }
    .btn-icon.run { background-color:var(--accent-primary); color:#fff; }
    .btn-icon svg { width: 18px; height: 18px; }
    #main-content { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
    .nav-tabs { border-bottom: 2px solid var(--border-color); flex-shrink: 0; padding: 0 8px; }
    .nav-tabs .nav-link { border: none; color: var(--text-secondary); margin-bottom: -2px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; border-top-left-radius: 6px; border-top-right-radius: 6px; }
    .nav-tabs .nav-link.active { background: var(--bg-tertiary); color: var(--accent-primary); border-top: 2px solid var(--accent-primary); font-weight: 500; }
    .tab-close-btn { font-family: monospace; font-weight: bold; font-size: 16px; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; line-height: 1; padding-bottom: 2px; cursor: pointer; transition: all 0.2s ease; }
    #editor-panes { flex-grow: 1; position: relative; }
    .tab-pane, .CodeMirror { height: 100%; width: 100%; }
    #editor-panes .tab-pane { position: absolute; top: 0; left: 0; opacity: 0; visibility: hidden; transition: opacity 0.1s; }
    #editor-panes .tab-pane.active { opacity: 1; visibility: visible; z-index: 1; }
    #consoleWrap { position:fixed; bottom:0; left:0; right:0; background: var(--bg-tertiary); border-top: 1px solid var(--border-color); transition:height 0.2s ease; height:0; display:flex; flex-direction:column; overflow:hidden; z-index:9999; box-shadow: 0 -4px 15px rgba(0,0,0,0.3); }
    .c-head { display:flex; align-items:center; justify-content:space-between; padding: 8px 12px; background: var(--bg-primary); cursor: ns-resize; user-select:none; touch-action:none; }
    .btn-icon-sm { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 6px; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    .dropdown-menu, .modal-content { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; z-index: 10000; color: var(--text-primary); }
    .dropdown-item { display: flex; align-items: center; gap: .5rem; color: var(--text-secondary); border-radius: 6px; padding: 8px 12px; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10001; }
    .toast-message { background-color: var(--accent-green); color: var(--bg-tertiary); padding: 10px 16px; border-radius: 6px; font-weight: 500; box-shadow: var(--shadow-sm); opacity: 0; transition: opacity 0.3s ease; }
    .pill-saving { display: inline-block; padding: 2px 8px; font-size: 10px; font-weight: 500; border-radius: 10px; background-color: var(--accent-primary); color: var(--bg-primary); margin-left: auto; opacity: 0.7; }
    .pill-saving.dirty { animation: blink-animation 1.5s ease-in-out infinite; }
    @keyframes blink-animation { 50% { opacity: 1; } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="app-container">
  <div class="top-bar">
    <button class="btn-icon run" id="runBtn" title="–í–∏–∫–æ–Ω–∞—Ç–∏ (Ctrl+Enter)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>
    <button class="btn-icon" id="consoleToggleBtn" title="–ö–æ–Ω—Å–æ–ª—å"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg></button>
    <button class="btn-icon hidden" id="installPwaBtn" title="–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="8 17 12 21 16 17"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"></path></svg>
    </button>
    <button class="btn-icon" id="fullscreenBtn" title="–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω (F11)">
        <svg id="icon-maximize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
        <svg id="icon-minimize" style="display:none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
    </button>
    <button class="btn-icon hidden" id="emmetBtn" title="–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ Emmet">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>
    </button>
    <div class="dropdown">
      <button class="btn-icon" type="button" data-bs-toggle="dropdown" title="–ú–µ–Ω—é"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" id="newFileBtn">‚ûï –ù–æ–≤–∏–π —Ñ–∞–π–ª</a></li>
        <li>
            <label class="dropdown-item" for="importZipInput" style="cursor: pointer;">üìÇ –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–æ—î–∫—Ç</label>
            <input type="file" id="importZipInput" hidden accept=".zip">
        </li>
        <li><a class="dropdown-item" href="#" id="saveToBrowserBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –±—Ä–∞—É–∑–µ—Ä <span id="savingPill" class="pill-saving" style="display: none;">–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è...</span></a></li>
        <li><a class="dropdown-item" href="#" id="downloadZipBtn">üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —è–∫ ZIP</a></li>
        <li><hr class="dropdown-divider" style="border-color: var(--border-color);"></li>
        <li><label class="dropdown-item"><input type="checkbox" id="autoRefreshToggle" class="form-check-input"> –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è</label></li>
        <li><label class="dropdown-item"><input type="checkbox" id="wrapToggle" class="form-check-input"> –ü–µ—Ä–µ–Ω–æ—Å –ø–æ —Å–ª–æ–≤–∞–º</label></li>
        <li><label class="dropdown-item"><input type="checkbox" id="offlineModeToggle" class="form-check-input"> üõú –û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º</label></li>
        <li><hr class="dropdown-divider" style="border-color: var(--border-color);"></li>
        <li><a class="dropdown-item" href="https://docs.emmet.io/cheat-sheet/" target="_blank" rel="noopener noreferrer">üìñ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è Emmet</a></li>
        <li><a class="dropdown-item" href="#" id="mLibs">üìö –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏</a></li>
      </ul>
    </div>
  </div>

  <div id="main-content">
    <ul class="nav nav-tabs" id="editor-tabs"></ul>
    <div class="tab-content" id="editor-panes"></div>
  </div>
</div>

<div id="consoleWrap"></div>
<div id="toast-container"></div>
<div class="modal fade" id="libsModal"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== STATE & CONSTANTS =====
const LS_PROJECT = 'editor_project_v15_files';
const LS_LIBS = 'editor_libs_v1';
const LS_WRAP = 'wrap_pref_v2';
const LS_AUTOREFRESH = 'auto_refresh_pref_v1';
const LS_OFFLINE_MODE = 'offline_mode_v1';
const $ = s => document.querySelector(s);

let editors = {}; let projectFiles = []; let libs = []; let activeFile = ''; let runWin = null;
let wrapOption = false; let autoRefreshEnabled = false; let offlineModeEnabled = false;
let deferredPrompt;
const logs = []; let logCount = 0; const cmdHistory = []; let histIdx = -1;

// ===== HELPERS =====
const getEditorMode = (filename) => { const ext = (filename.split('.').pop() || '').toLowerCase(); if (ext === 'js') return 'javascript'; if (ext === 'css') return 'css'; if (ext === 'html' || ext === 'htm') return 'htmlmixed'; return 'text/plain'; };
const debounce = (fn, ms = 1500) => { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); }; };
const safeScript = s => String(s).replace(/<\/script>/gi, '<\\/script>');
function showToast(message) {
    const container = $('#toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = 1; }, 10);
    setTimeout(() => { toast.style.opacity = 0; setTimeout(() => toast.remove(), 300); }, 2000);
}
function setSavingPill(isDirty) {
    const pill = $('#savingPill');
    if (isDirty) {
        pill.style.display = 'inline-block';
        pill.classList.add('dirty');
    } else {
        pill.style.display = 'none';
        pill.classList.remove('dirty');
    }
}
function updateContextualUI(filename) {
    const mode = getEditorMode(filename);
    const emmetBtn = $('#emmetBtn');
    if (mode === 'htmlmixed' || mode === 'css') {
        emmetBtn.classList.remove('hidden');
    } else {
        emmetBtn.classList.add('hidden');
    }
}

// ===== CORE FILE & TAB MANAGEMENT =====
function createTab(filename, content = '', isActive = false) {
    if (editors[filename]) { switchTab(filename); return; }
    const paneId = `pane-${filename.replace(/[^a-zA-Z0-9]/g, '')}`;
    const tabContainer = $('#editor-tabs');
    const tab = document.createElement('li'); tab.className = 'nav-item';
    const isProtected = filename === 'index.html';
    tab.innerHTML = `<button class="nav-link ${isActive ? 'active' : ''}" data-bs-toggle="tab" data-bs-target="#${paneId}" type="button" role="tab" data-filename="${filename}">${filename}${!isProtected ? `<span class="tab-close-btn" data-filename="${filename}">&times;</span>` : ''}</button>`;
    tabContainer.appendChild(tab);
    
    const paneContainer = $('#editor-panes');
    const pane = document.createElement('div');
    pane.className = `tab-pane fade ${isActive ? 'show active' : ''}`; pane.id = paneId;
    const textarea = document.createElement('textarea'); pane.appendChild(textarea);
    paneContainer.appendChild(pane);

    const mode = getEditorMode(filename);
    const editorOptions = { lineNumbers: true, mode: mode, theme: 'dracula', lineWrapping: wrapOption };
    if (mode === 'htmlmixed' || mode === 'css') {
        editorOptions.extraKeys = { 'Tab': 'emmetExpandAbbreviation', 'Enter': 'emmetInsertLineBreak' };
    }

    const editor = CodeMirror.fromTextArea(textarea, editorOptions);
    editor.setValue(content);
    editor.on('change', () => { markDirty(); if (autoRefreshEnabled && runWin && !runWin.closed) { debouncedRefresh(); } });
    
    editors[filename] = editor;
    if (!projectFiles.some(f => f.name === filename)) { projectFiles.push({ name: filename, content }); }
    if (isActive) { activeFile = filename; updateContextualUI(filename); }
}
function switchTab(filename) { 
    const tabButton = $(`button[data-filename="${filename}"]`); 
    if (tabButton) { 
        new bootstrap.Tab(tabButton).show(); 
        activeFile = filename; 
        updateContextualUI(filename);
        setTimeout(() => editors[filename] && editors[filename].refresh(), 50); 
    } 
}
function closeTab(filename) { if (filename === 'index.html') return; $(`button[data-filename="${filename}"]`).parentElement.remove(); $(`#pane-${filename.replace(/[^a-zA-Z0-9]/g, '')}`).remove(); delete editors[filename]; projectFiles = projectFiles.filter(f => f.name !== filename); switchTab('index.html'); markDirty(); }
function resetUI() { $('#editor-tabs').innerHTML = ''; $('#editor-panes').innerHTML = ''; editors = {}; projectFiles = []; }

// ===== PROJECT SAVE/LOAD & OFFLINE =====
let dirty = false;
function markDirty() { dirty = true; setSavingPill(true); debouncedSave(); }
const saveProject = () => { projectFiles.forEach(file => { if (editors[file.name]) { file.content = editors[file.name].getValue(); } }); localStorage.setItem(LS_PROJECT, JSON.stringify(projectFiles)); dirty = false; setSavingPill(false); };
const debouncedSave = debounce(saveProject, 1500);
function loadProject() {
    const savedData = localStorage.getItem(LS_PROJECT);
    if (savedData) { try { projectFiles = JSON.parse(savedData); if (!projectFiles.some(f => f.name === 'index.html')) throw new Error("No index.html"); } catch { projectFiles = []; } }
    if (projectFiles.length === 0) {
        projectFiles = [
            { name: 'index.html', content: '<h1>Hello, Emmet!</h1>\n<p>Try typing `p*3>lorem5` and pressing Tab.</p>' },
            { name: 'style.css', content: 'body { \n  font-family: sans-serif; \n  padding: 1rem; \n}' },
            { name: 'script.js', content: 'console.log("Welcome!");' }
        ];
    }
    resetUI();
    projectFiles.forEach((file, index) => createTab(file.name, file.content, index === 0));
}

// ===== SERVICE WORKER & PWA =====
function manageServiceWorker() {
    if (!('serviceWorker' in navigator)) { return; }
    if (offlineModeEnabled) {
        navigator.serviceWorker.getRegistration().then(reg => {
            if (!reg) { navigator.serviceWorker.register('./sw.js').then(reg => showToast('–û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ.')).catch(err => console.error('SW Registration Error:', err)); }
        });
    } else {
        navigator.serviceWorker.getRegistration().then(registration => {
            if (registration) { registration.unregister().then(isUnregistered => { if (isUnregistered) { showToast('–û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º –≤–∏–º–∫–Ω–µ–Ω–æ.'); caches.keys().then(keys => keys.forEach(key => caches.delete(key))); } }); }
        });
    }
}
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBtn = $('#installPwaBtn');
    if(installBtn) installBtn.classList.remove('hidden');
});
async function handleInstallClick() {
    const installBtn = $('#installPwaBtn');
    if (!deferredPrompt || !installBtn) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.classList.add('hidden');
}
window.addEventListener('appinstalled', () => {
    deferredPrompt = null;
    showToast('–î–æ–¥–∞—Ç–æ–∫ —É—Å–ø—ñ—à–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
});

// ===== RUN CODE & FULLSCREEN =====
function runCode() { /* ... Compiles and runs the code in a new window ... */ }
const debouncedRefresh = debounce(runCode, 1500);
function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else if (document.exitFullscreen) { document.exitFullscreen(); } }


// ===== INITIALIZATION & EVENT LISTENERS =====
document.addEventListener('DOMContentLoaded', () => {
    wrapOption = localStorage.getItem(LS_WRAP) === '1';
    autoRefreshEnabled = localStorage.getItem(LS_AUTOREFRESH) === '1';
    offlineModeEnabled = localStorage.getItem(LS_OFFLINE_MODE) === '1';

    $('#wrapToggle').checked = wrapOption;
    $('#autoRefreshToggle').checked = autoRefreshEnabled;
    $('#offlineModeToggle').checked = offlineModeEnabled;
    
    loadProject();
    manageServiceWorker();

    // Event listeners are complete and restored here
    $('#editor-tabs').addEventListener('click', e => { const closeBtn = e.target.closest('.tab-close-btn'); if (closeBtn) { e.stopPropagation(); const filename = closeBtn.dataset.filename; if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ ${filename}?`)) { closeTab(filename); } } const tabBtn = e.target.closest('.nav-link'); if (tabBtn) { switchTab(tabBtn.dataset.filename); } });
    $('#runBtn').addEventListener('click', runCode);
    $('#fullscreenBtn').addEventListener('click', toggleFullScreen);
    $('#installPwaBtn').addEventListener('click', handleInstallClick);
    $('#emmetBtn').addEventListener('click', () => { if (editors[activeFile]) { editors[activeFile].execCommand('emmetExpandAbbreviation'); } });
    document.addEventListener('fullscreenchange', () => { const isFullscreen = !!document.fullscreenElement; $('#icon-maximize').style.display = isFullscreen ? 'none' : 'block'; $('#icon-minimize').style.display = isFullscreen ? 'block' : 'none'; });
    $('#newFileBtn').addEventListener('click', e => { e.preventDefault(); const filename = prompt("–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è —Ñ–∞–π–ª—É:"); if (filename && filename.trim()) { if (editors[filename]) { alert("–§–∞–π–ª –∑ —Ç–∞–∫–∏–º —ñ–º–µ–Ω–µ–º –≤–∂–µ —ñ—Å–Ω—É—î."); return; } createTab(filename, ``, true); } });
    $('#downloadZipBtn').addEventListener('click', e => { e.preventDefault(); /* exportToZip(); */ });
    $('#saveToBrowserBtn').addEventListener('click', e => { e.preventDefault(); saveProject(); showToast('–ü—Ä–æ—î–∫—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä!'); });
    $('#importZipInput').addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { /* loadProjectFromZip(file); */ } e.target.value = ''; });
    $('#wrapToggle').addEventListener('change', e => { wrapOption = e.target.checked; localStorage.setItem(LS_WRAP, wrapOption ? '1' : '0'); Object.values(editors).forEach(ed => ed.setOption('lineWrapping', wrapOption)); });
    $('#autoRefreshToggle').addEventListener('change', e => { autoRefreshEnabled = e.target.checked; localStorage.setItem(LS_AUTOREFRESH, autoRefreshEnabled ? '1' : '0'); });
    $('#offlineModeToggle').addEventListener('change', e => { offlineModeEnabled = e.target.checked; localStorage.setItem(LS_OFFLINE_MODE, offlineModeEnabled ? '1' : '0'); manageServiceWorker(); });
    document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); runCode(); } if (e.key === 'F11') { e.preventDefault(); toggleFullScreen(); } });
    $('#consoleToggleBtn').addEventListener('click', () => { /* toggleConsole(); */ });
});
</script>

</body>
</html>
